name: Build LineageOS Kernel (Manual Injection Mode)

on:
  workflow_dispatch:
    inputs:
      LINEAGE_BRANCH:
        description: 'LineageOS åˆ†æ”¯'
        required: true
        default: 'lineage-23.0'
      
      ENABLE_SUSFS:
        description: 'å¯ç”¨ SusFS'
        required: true
        type: boolean
        default: true

      ENABLE_LSM:
        description: 'å¯ç”¨ LSM / BBG'
        required: true
        type: boolean
        default: true

env:
  TZ: Asia/Shanghai
  CLANG_VERSION: clang-r547379
  GCC_TAG: android-12.1.0_r27

jobs:
  build:
    name: Build Kernel
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Set swap to 10G
      uses: pierotofy/set-swap-space@master
      with:
        swap-size-gb: 10

    - name: Setup Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y git ccache automake flex lzop bison gperf build-essential zip curl zlib1g-dev g++-multilib bzip2 libbz2-dev liblz4-tool make squashfs-tools dpkg-dev libssl-dev python3 bc libc6-dev-i386 libncurses5-dev
        mkdir -p $GITHUB_WORKSPACE/kernel_workspace

    - name: Download Toolchains
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        mkdir -p clang-aosp gcc-64
        wget -O clang.tar.gz https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/${CLANG_VERSION}.tar.gz
        tar -C clang-aosp -zxvf clang.tar.gz
        wget -O gcc.tar.gz https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/+archive/refs/tags/${GCC_TAG}.tar.gz
        tar -C gcc-64 -zxvf gcc.tar.gz

    - name: Download Kernel Source
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        git clone --recursive https://github.com/LineageOS/android_kernel_oneplus_sm8250 -b ${{ inputs.LINEAGE_BRANCH }} android-kernel --depth=1

    - name: Setup KernelSU (Manual Clone)
      run: |
        cd kernel_workspace/android-kernel
        
        # ğŸ”¥ ç›´æ¥å…‹éš†æºç ï¼Œä¸ä¾èµ– setup.shï¼Œç¡®ä¿ç›®å½•ç»“æ„æ¸…æ™°
        echo "â¬‡ï¸ Cloning KernelSU (rsuntk) manually..."
        rm -rf KernelSU
        git clone https://github.com/rsuntk/KernelSU.git KernelSU
        
        # éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "KernelSU/kernel/core_hook.c" ]; then
            echo "âŒ Error: KernelSU download failed!"
            exit 1
        fi
        
        # å»ºç«‹è½¯é“¾æ¥ (æ¨¡æ‹Ÿ setup.sh çš„è¡Œä¸º)
        ln -sf KernelSU/kernel drivers/kernelsu
        
        # ä¿®æ”¹ Makefile
        if ! grep -q "kernelsu" drivers/Makefile; then
            echo "obj-y += kernelsu/" >> drivers/Makefile
        fi
        
        echo "CONFIG_KSU=y" >> arch/arm64/configs/vendor/kona-perf_defconfig
        echo "CONFIG_KSU_MANUAL_HOOK=y" >> arch/arm64/configs/vendor/kona-perf_defconfig
        
        echo "âœ… KernelSU installed manually."

    # ğŸ”¥ å…¨æ‰‹åŠ¨æ¤å…¥ SusFS (ä¸ä¾èµ– patch æ–‡ä»¶)
    - name: Inject SusFS (Manual Surgery)
      if: inputs.ENABLE_SUSFS == true
      run: |
        cd kernel_workspace
        git clone https://gitlab.com/simonpunk/susfs4ksu.git -b kernel-4.19
        
        cd android-kernel
        
        # 1. å¤åˆ¶æ–‡ä»¶
        echo "ğŸ“‹ Copying SusFS files..."
        cp -af "../susfs4ksu/kernel_patches/fs/"* fs/
        cp -af "../susfs4ksu/kernel_patches/include/linux/"* include/linux/
        
        # 2. æ‰‹åŠ¨ä¿®æ”¹ fs/Makefile (æ›¿ä»£ patch)
        echo "ğŸ”§ Modifying fs/Makefile..."
        if ! grep -q "susfs.o" fs/Makefile; then
            echo "obj-\$(CONFIG_KSU_SUSFS) += susfs.o" >> fs/Makefile
        fi
        
        # 3. æ‰‹åŠ¨ä¿®æ”¹ fs/Kconfig (æ›¿ä»£ patch)
        # æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬ç›´æ¥æŠŠé…ç½®åŠ åˆ° defconfig é‡Œäº†ï¼ŒKconfig ä¸æ”¹ä¹Ÿèƒ½ç¼–è¿‡å»ï¼Œæˆ–è€…ç®€å•è¿½åŠ 
        
        # 4. æ‰‹åŠ¨ Hook KernelSU (è§£å†³ 0x555e1 æŠ¥é”™)
        echo "ğŸ”§ Hooking KernelSU core_hook.c..."
        TARGET_FILE="KernelSU/kernel/core_hook.c"
        
        if [ -f "$TARGET_FILE" ]; then
            # æ’å…¥å¤´æ–‡ä»¶
            if ! grep -q "linux/susfs.h" "$TARGET_FILE"; then
                sed -i '/#include "ksu.h"/a #include <linux/susfs.h>' "$TARGET_FILE"
            fi
            
            # æ’å…¥è°ƒç”¨é€»è¾‘
            if ! grep -q "susfs_ksu_ioctl" "$TARGET_FILE"; then
                sed -i '/int ksu_handle_ioctl/a \ \ \ \ if (susfs_ksu_ioctl(cmd, arg, 0)) return 0;' "$TARGET_FILE"
            fi
            echo "âœ… KSU Hook injected successfully."
        else
            echo "âŒ CRITICAL: $TARGET_FILE not found! Build aborted."
            exit 1
        fi
        
        # 5. å¼€å¯é…ç½®
        CONFIG_FILE="arch/arm64/configs/vendor/kona-perf_defconfig"
        echo "CONFIG_KSU_SUSFS=y" >> $CONFIG_FILE
        echo "CONFIG_KSU_SUSFS_SUS_PATH=y" >> $CONFIG_FILE
        echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y" >> $CONFIG_FILE
        echo "CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y" >> $CONFIG_FILE
        echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y" >> $CONFIG_FILE
        echo "CONFIG_KSU_SUSFS_SUS_OVERLAYFS=y" >> $CONFIG_FILE
        echo "CONFIG_KSU_SUSFS_TRY_UMOUNT=y" >> $CONFIG_FILE
        echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y" >> $CONFIG_FILE

    - name: Inject Kernel Extensions
      run: |
        cd kernel_workspace/android-kernel
        CONFIG_FILE="arch/arm64/configs/vendor/kona-perf_defconfig"
        
        # LSM / BBG
        if [ "${{ inputs.ENABLE_LSM }}" == "true" ]; then
            curl -LSs https://raw.githubusercontent.com/vc-teahouse/Baseband-guard/main/setup.sh | bash
            echo "CONFIG_BBG=y" >> $CONFIG_FILE
            sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/selinux/selinux,baseband_guard/ } }' security/Kconfig
        fi

    - name: Build Kernel
      run: |
        cd kernel_workspace/android-kernel
        export ARCH=arm64
        export SUBARCH=arm64
        export BRAND_SHOW_FLAG=oneplus
        export PATH=$GITHUB_WORKSPACE/kernel_workspace/clang-aosp/bin:$GITHUB_WORKSPACE/kernel_workspace/gcc-64/bin:$PATH
        export KBUILD_BUILD_HOST=Github-Action
        export KBUILD_BUILD_USER=builder

        # è·å– KSU ç‰ˆæœ¬ç”¨äºå‘½å
        cd KernelSU
        KSU_VER=$(expr $(git rev-list --count HEAD) + 10000)
        cd ..
        echo "RSKSUVER=$KSU_VER" >> $GITHUB_ENV

        BA_CMD="CLANG_TRIPLE=aarch64-linux-gnu- CROSS_COMPILE=aarch64-linux-android-"
        EX_CMD="LD=ld.lld LLVM=1 LLVM_IAS=1"
        DEFCONFIG="vendor/kona-perf_defconfig vendor/debugfs.config vendor/oplus.config"

        make O=out CC=clang $BA_CMD $EX_CMD $DEFCONFIG
        
        # é‡åˆ°é”™è¯¯ç«‹å³åœæ­¢ (-j åä¸åŠ  k)
        make -j$(nproc --all) O=out CC=clang $BA_CMD $EX_CMD KCFLAGS=-w KCPPFLAGS=-w

    - name: Package Kernel
      run: |
        cd kernel_workspace
        git clone --depth=1 https://github.com/osm0sis/AnyKernel3
        
        if [ -f android-kernel/out/arch/arm64/boot/Image ]; then
            cp android-kernel/out/arch/arm64/boot/Image AnyKernel3/
        else
            echo "âŒ Build Failed: Image not found"
            exit 1
        fi
        
        cd AnyKernel3
        sed -i 's/do.devicecheck=1/do.devicecheck=0/g' anykernel.sh
        sed -i 's!BLOCK=/dev/block/platform/omap/omap_hsmmc.0/by-name/boot;!BLOCK=auto;!g' anykernel.sh
        sed -i 's/IS_SLOT_DEVICE=0;/IS_SLOT_DEVICE=auto;/g' anykernel.sh
        rm -rf .git* README.md

        TAG=""
        [ "${{ inputs.ENABLE_SUSFS }}" == "true" ] && TAG="${TAG}-SusFS"
        
        zip -r "AK3-${{ inputs.LINEAGE_BRANCH }}-OP8-rsuntk${TAG}_KSU_${{ env.RSKSUVER }}.zip" ./*
        echo "ZIP_NAME=$(ls *.zip)" >> $GITHUB_ENV

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Kernel-Result
        path: kernel_workspace/AnyKernel3/*.zip

    - name: Send to Telegram
      if: success()
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        cd kernel_workspace/AnyKernel3
        curl -s -F chat_id=$TELEGRAM_CHAT_ID \
             -F document=@"${{ env.ZIP_NAME }}" \
             -F caption="âœ… Build Success: ${{ env.ZIP_NAME }}" \
             https://api.telegram.org/bot$TELEGRAM_TOKEN/sendDocument
