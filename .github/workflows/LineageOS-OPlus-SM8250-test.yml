- name: Integrate SusFS into kernel (rksu)
  if: inputs.ENABLE_SUSFS == true
  shell: bash
  run: |
    set -euo pipefail
    cd "$GITHUB_WORKSPACE/kernel_workspace/android-kernel"

    # 1) 打 SusFS 主补丁（内核侧）
    echo "== Applying susfs_patch_to_4.19.patch =="
    patch -p1 < "$GITHUB_WORKSPACE/patches/susfs/susfs_patch_to_4.19.patch" || true

    # 2) 可选：打 fixed 修复补丁（如果你有）
    if [ -f "$GITHUB_WORKSPACE/patches/susfs/susfs_fixed.patch" ]; then
      echo "== Applying susfs_fixed.patch =="
      patch -p1 < "$GITHUB_WORKSPACE/patches/susfs/susfs_fixed.patch" || true
    fi

    if [ -f "$GITHUB_WORKSPACE/patches/susfs/susfs_155_fixed.patch" ]; then
      echo "== Applying susfs_155_fixed.patch =="
      patch -p1 < "$GITHUB_WORKSPACE/patches/susfs/susfs_155_fixed.patch" || true
    fi

    # 3) 失败就把 rej 打出来（避免“继续编译但最终不可用”）
    REJ=$(find . -name "*.rej" | wc -l || true)
    if [ "$REJ" -ne 0 ]; then
      echo "!! SusFS patch has rejects:"
      find . -name "*.rej" -print -maxdepth 6
      # 这里建议直接失败，或者你也可以允许存在 rej 并走 fixed 补丁路线
      exit 1
    fi

    # 4) 写 defconfig（确保 KSU_SUSFS 真能编进去）
    CONFIG_FILE="arch/arm64/configs/vendor/kona-perf_defconfig"
    {
      echo "CONFIG_KSU_SUSFS=y"
      echo "CONFIG_KSU_SUSFS_SUS_PATH=y"
      echo "CONFIG_KSU_SUSFS_SUS_MOUNT=y"
      echo "CONFIG_KSU_SUSFS_SUS_KSTAT=y"
      echo "CONFIG_KSU_SUSFS_SPOOF_UNAME=y"
      echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y"
      echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y"
      echo "CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y"
      echo "CONFIG_KSU_SUSFS_OPEN_REDIRECT=y"
      echo "CONFIG_KSU_SUSFS_SUS_MAP=y"
    } >> "$CONFIG_FILE"

    # 5) 硬校验：让 Makefile:121 不再 Stop
    echo "== Verify SusFS integrated markers =="
    # 这些检查项是“最常见”的 SusFS 集成标志
    (ls include/linux | grep -i susfs) || (echo "missing susfs header" && exit 1)
    (ls fs | grep -i susfs) || (echo "missing susfs fs code" && exit 1)
    grep -R "CONFIG_KSU_SUSFS" -n fs/namespace.c >/dev/null 2>&1 || true
    echo "✅ SusFS seems integrated."
