name: LineageOS OPlus SM8250 - SukiSU-Ultra (SusFS + KPM)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      # ===== 按你自己的仓库改这 3 个 =====
      KERNEL_REPO: https://github.com/OnePlusOSS/android_kernel_oneplus_sm8250.git
      KERNEL_BRANCH: android12
      DEFCONFIG: vendor/kona_defconfig
      # ===================================

      SUKISU_REPO: https://github.com/SukiSU-Ultra/SukiSU-Ultra.git
      SUKISU_BRANCH: main

      ARCH: arm64
      SUBARCH: arm64
      CCACHE_COMPRESS: "1"
      CCACHE_MAXSIZE: 4G

    steps:
      - name: Checkout this repo (patches + workflow)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            bc bison build-essential ccache curl flex g++ gcc git gnupg gperf \
            imagemagick libncurses5-dev libssl-dev libtinfo5 libxml2-utils lz4 \
            make ninja-build openjdk-11-jdk python3 python3-pip rsync unzip \
            wget zip zstd

      - name: Prepare ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          max-size: 4G

      - name: Clone kernel source
        run: |
          set -euo pipefail
          rm -rf kernel_workspace
          mkdir -p kernel_workspace
          cd kernel_workspace
          git clone --depth=1 -b "${KERNEL_BRANCH}" "${KERNEL_REPO}" android-kernel

      - name: Clone SukiSU-Ultra
        run: |
          set -euo pipefail
          cd kernel_workspace
          rm -rf sukisu
          git clone --depth=1 -b "${SUKISU_BRANCH}" "${SUKISU_REPO}" sukisu

      - name: Integrate SukiSU-Ultra into kernel tree
        run: |
          set -euo pipefail
          KDIR="${GITHUB_WORKSPACE}/kernel_workspace/android-kernel"
          SDIR="${GITHUB_WORKSPACE}/kernel_workspace/sukisu"

          rm -rf "${KDIR}/drivers/kernelsu"
          mkdir -p "${KDIR}/drivers"
          cp -a "${SDIR}/drivers/kernelsu" "${KDIR}/drivers/"

          if ! grep -q 'drivers/kernelsu/Kconfig' "${KDIR}/drivers/Kconfig"; then
            echo 'source "drivers/kernelsu/Kconfig"' >> "${KDIR}/drivers/Kconfig"
          fi

          if ! grep -q 'obj-$(CONFIG_KSU) += kernelsu/' "${KDIR}/drivers/Makefile"; then
            echo 'obj-$(CONFIG_KSU) += kernelsu/' >> "${KDIR}/drivers/Makefile"
          fi

      - name: Apply SusFS patches (OnePlus 8 / 4.19)
        run: |
          set -euo pipefail
          KDIR="${GITHUB_WORKSPACE}/kernel_workspace/android-kernel"
          cd "${KDIR}"

          git apply --verbose "${GITHUB_WORKSPACE}/patches/susfs_cmdline_oneplus8_419.patch"
          git apply --verbose "${GITHUB_WORKSPACE}/patches/susfs_fixups_oneplus8_419.patch"

      - name: Fix KPM access_ok for arm64 4.19 (2-arg -> 3-arg)
        run: |
          set -euo pipefail
          KPM_FILE="${GITHUB_WORKSPACE}/kernel_workspace/android-kernel/drivers/kernelsu/kpm/kpm.c"
          test -f "${KPM_FILE}"

          python3 - <<'PY'
import re, pathlib
p = pathlib.Path(r"""${GITHUB_WORKSPACE}/kernel_workspace/android-kernel/drivers/kernelsu/kpm/kpm.c""")
s = p.read_text(encoding="utf-8", errors="ignore")

# 把 access_ok(addr, size) -> access_ok(0, addr, size)
# 只替换“逗号只有一个”的两参形式，避免误伤三参。
pattern = re.compile(r'access_ok\s*\(\s*([^,()]+?)\s*,\s*([^)]+?)\s*\)')
def repl(m):
    a = m.group(1).strip()
    b = m.group(2).strip()
    return f'access_ok(0, {a}, {b})'
s2 = pattern.sub(repl, s)

p.write_text(s2, encoding="utf-8")
print("patched access_ok() calls:", len(pattern.findall(s)))
PY

          # 打印几行确认
          grep -n "access_ok" "${KPM_FILE}" | head -n 50 || true

      - name: Configure kernel
        run: |
          set -euo pipefail
          KDIR="${GITHUB_WORKSPACE}/kernel_workspace/android-kernel"
          cd "${KDIR}"
          make O=out "${DEFCONFIG}"

      - name: Build kernel
        run: |
          set -euo pipefail
          KDIR="${GITHUB_WORKSPACE}/kernel_workspace/android-kernel"
          cd "${KDIR}"
          make -j"$(nproc)" O=out

      - name: Collect artifacts
        run: |
          set -euo pipefail
          OUT="${GITHUB_WORKSPACE}/kernel_workspace/android-kernel/out"
          mkdir -p "${GITHUB_WORKSPACE}/artifacts"

          for f in \
            "${OUT}/arch/arm64/boot/Image" \
            "${OUT}/arch/arm64/boot/Image.gz" \
            "${OUT}/arch/arm64/boot/Image.gz-dtb"
          do
            if [ -f "$f" ]; then
              cp -v "$f" "${GITHUB_WORKSPACE}/artifacts/"
            fi
          done

          ls -lah "${GITHUB_WORKSPACE}/artifacts" || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-artifacts
          path: artifacts/*
