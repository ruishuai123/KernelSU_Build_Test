name: LineageOS OPlus SM8250 - SukiSU-Ultra (SusFS + KPM)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      KERNEL_REPO: https://github.com/OnePlusOSS/android_kernel_oneplus_sm8250.git
      KERNEL_BRANCH: android12
      DEFCONFIG: vendor/kona_defconfig

      SUKISU_REPO: https://github.com/SukiSU-Ultra/SukiSU-Ultra.git
      SUKISU_BRANCH: main

      ARCH: arm64
      SUBARCH: arm64

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            bc bison build-essential ccache curl flex g++ gcc git \
            libncurses5-dev libssl-dev make ninja-build python3 unzip \
            rsync zip zstd lz4

      - name: Clone kernel source
        run: |
          set -euo pipefail
          rm -rf kernel_workspace
          mkdir -p kernel_workspace
          cd kernel_workspace
          git clone --depth=1 -b "${KERNEL_BRANCH}" "${KERNEL_REPO}" android-kernel

      - name: Clone SukiSU-Ultra
        run: |
          set -euo pipefail
          cd kernel_workspace
          rm -rf sukisu
          git clone --depth=1 -b "${SUKISU_BRANCH}" "${SUKISU_REPO}" sukisu

      - name: Integrate SukiSU-Ultra into kernel tree
        run: |
          set -euo pipefail
          KDIR="${GITHUB_WORKSPACE}/kernel_workspace/android-kernel"
          SDIR="${GITHUB_WORKSPACE}/kernel_workspace/sukisu"

          rm -rf "${KDIR}/drivers/kernelsu"
          mkdir -p "${KDIR}/drivers"
          cp -a "${SDIR}/drivers/kernelsu" "${KDIR}/drivers/"

          if ! grep -q 'drivers/kernelsu/Kconfig' "${KDIR}/drivers/Kconfig"; then
            echo 'source "drivers/kernelsu/Kconfig"' >> "${KDIR}/drivers/Kconfig"
          fi

          if ! grep -q 'obj-$(CONFIG_KSU) += kernelsu/' "${KDIR}/drivers/Makefile"; then
            echo 'obj-$(CONFIG_KSU) += kernelsu/' >> "${KDIR}/drivers/Makefile"
          fi

      - name: Apply SusFS patches (OnePlus 8 / 4.19)
        run: |
          set -euo pipefail
          KDIR="${GITHUB_WORKSPACE}/kernel_workspace/android-kernel"
          cd "${KDIR}"

          git apply --verbose "${GITHUB_WORKSPACE}/patches/susfs_cmdline_oneplus8_419.patch"
          git apply --verbose "${GITHUB_WORKSPACE}/patches/susfs_fixups_oneplus8_419.patch"

      - name: Fix KPM access_ok for arm64 4.19
        run: |
          set -euo pipefail
          KPM_FILE="${GITHUB_WORKSPACE}/kernel_workspace/android-kernel/drivers/kernelsu/kpm/kpm.c"
          test -f "${KPM_FILE}"

          python3 - <<'PY'
          import re
          import pathlib

          p = pathlib.Path(r"""'"${KPM_FILE}"'""")
          s = p.read_text(encoding="utf-8", errors="ignore")

          # access_ok(addr, size)  ->  access_ok(0, addr, size)   (arm64 4.19: access_ok(type, addr, size))
          pat = re.compile(r'access_ok\s*\(\s*([^,()]+?)\s*,\s*([^)]+?)\s*\)')
          s2 = pat.sub(lambda m: f'access_ok(0, {m.group(1).strip()}, {m.group(2).strip()})', s)

          p.write_text(s2, encoding="utf-8")
          print("patched access_ok calls:", len(pat.findall(s)))
          PY

          grep -n "access_ok" "${KPM_FILE}" | head -n 80 || true

      - name: Configure kernel
        run: |
          set -euo pipefail
          cd "${GITHUB_WORKSPACE}/kernel_workspace/android-kernel"
          make O=out "${DEFCONFIG}"

      - name: Build kernel
        run: |
          set -euo pipefail
          cd "${GITHUB_WORKSPACE}/kernel_workspace/android-kernel"
          make -j"$(nproc)" O=out

      - name: Collect artifacts
        run: |
          set -euo pipefail
          OUT="${GITHUB_WORKSPACE}/kernel_workspace/android-kernel/out"
          mkdir -p "${GITHUB_WORKSPACE}/artifacts"

          for f in \
            "${OUT}/arch/arm64/boot/Image" \
            "${OUT}/arch/arm64/boot/Image.gz" \
            "${OUT}/arch/arm64/boot/Image.gz-dtb"
          do
            if [ -f "$f" ]; then
              cp -v "$f" "${GITHUB_WORKSPACE}/artifacts/"
            fi
          done

          ls -lah "${GITHUB_WORKSPACE}/artifacts" || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-artifacts
          path: artifacts
