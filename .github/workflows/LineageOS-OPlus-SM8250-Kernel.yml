name: Build OnePlus 8 Kernel (Custom UI)

on:
  workflow_dispatch:
    inputs:
      KERNEL_SOURCE:
        description: '内核源码地址 (Source URL)'
        required: true
        default: 'https://github.com/LineageOS/android_kernel_oneplus_sm8250'
      KERNEL_BRANCH:
        description: '内核分支 (Branch)'
        required: true
        default: 'lineage-23.1'
      KERNEL_DEFCONFIG:
        description: '配置文件 (Defconfig)'
        required: true
        default: 'vendor/kona-perf_defconfig'
      CLANG_VERSION:
        description: 'Clang 版本 (如 clang-r547379)'
        required: true
        default: 'clang-r547379'

env:
  TZ: Asia/Shanghai
  GCC_TAG: android-12.1.0_r27

jobs:
  build:
    name: Build Kernel (rsuntk)
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Set swap to 10G
      uses: pierotofy/set-swap-space@master
      with:
        swap-size-gb: 10

    - name: Setup Environment
      run: |
        echo "BUILD_TIME=$(TZ=Asia/Shanghai date "+%y%m%d")" >> $GITHUB_ENV
        sudo apt-get update
        sudo apt-get install -y git ccache automake flex lzop bison gperf build-essential zip curl zlib1g-dev g++-multilib bzip2 libbz2-dev liblz4-tool make squashfs-tools dpkg-dev libssl-dev python3 bc libc6-dev-i386 libncurses5-dev
        mkdir -p $GITHUB_WORKSPACE/kernel_workspace

    - name: Cache Clang
      id: cache-clang
      uses: actions/cache@v4
      with:
        path: ${{ github.workspace }}/kernel_workspace/clang-aosp
        key: ${{ inputs.CLANG_VERSION }}

    - name: Download Clang (If not cached)
      if: steps.cache-clang.outputs.cache-hit != 'true'
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        mkdir -p clang-aosp
        wget -O clang.tar.gz https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/${{ inputs.CLANG_VERSION }}.tar.gz
        tar -C clang-aosp -zxvf clang.tar.gz

    - name: Cache GCC
      id: cache-gcc
      uses: actions/cache@v4
      with:
        path: ${{ github.workspace }}/kernel_workspace/gcc-64
        key: gcc-aarch64-${{ env.GCC_TAG }}

    - name: Download GCC (If not cached)
      if: steps.cache-gcc.outputs.cache-hit != 'true'
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        mkdir -p gcc-64
        wget -O gcc.tar.gz https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/+archive/refs/tags/${{ env.GCC_TAG }}.tar.gz
        tar -C gcc-64 -zxvf gcc.tar.gz

    - name: Clone Kernel Source
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        echo "Cloning: ${{ inputs.KERNEL_SOURCE }}"
        echo "Branch: ${{ inputs.KERNEL_BRANCH }}"
        git clone --recursive ${{ inputs.KERNEL_SOURCE }} -b ${{ inputs.KERNEL_BRANCH }} android-kernel --depth=1

    - name: Inject KernelSU (rsuntk only)
      run: |
        cd kernel_workspace/android-kernel
        
        # 下载 rsuntk 版 KernelSU
        curl -LSs https://raw.githubusercontent.com/rsuntk/KernelSU/main/kernel/setup.sh | bash -s main
        
        # 尝试打补丁 (如果仓库里有 patches 文件夹的话)
        if [ -f "$GITHUB_WORKSPACE/patches/kernel-4.19_5.4-patch.sh" ]; then
            bash $GITHUB_WORKSPACE/patches/kernel-4.19_5.4-patch.sh || true
        fi
        
        # 开启 Manual Hook
        echo "CONFIG_KSU_MANUAL_HOOK=y" >> arch/arm64/configs/${{ inputs.KERNEL_DEFCONFIG }}
        
        # 获取 KSU 版本号用于命名
        RSKSUVER=$(cd KernelSU && expr $(git rev-list --count HEAD) + 30000)
        echo "RSKSUVER=$RSKSUVER" >> $GITHUB_ENV
        
        # 清除 dirty 标记
        sed -i 's/ -dirty//g' scripts/setlocalversion

    - name: Build Kernel
      run: |
        cd kernel_workspace/android-kernel
        export ARCH=arm64
        export SUBARCH=arm64
        export BRAND_SHOW_FLAG=oneplus
        export PATH=$GITHUB_WORKSPACE/kernel_workspace/clang-aosp/bin:$GITHUB_WORKSPACE/kernel_workspace/gcc-64/bin:$PATH
        
        # 核心编译命令
        make O=out CC=clang \
             CLANG_TRIPLE=aarch64-linux-gnu- \
             CROSS_COMPILE=aarch64-linux-android- \
             LD=ld.lld LLVM=1 LLVM_IAS=1 \
             ${{ inputs.KERNEL_DEFCONFIG }} vendor/debugfs.config vendor/oplus.config
             
        make -j$(nproc --all) O=out CC=clang \
             CLANG_TRIPLE=aarch64-linux-gnu- \
             CROSS_COMPILE=aarch64-linux-android- \
             LD=ld.lld LLVM=1 LLVM_IAS=1

    - name: Package AnyKernel3
      run: |
        cd kernel_workspace
        git clone --depth=1 https://github.com/osm0sis/AnyKernel3
        
        # 检查 Image 是否生成
        if [ -f android-kernel/out/arch/arm64/boot/Image ]; then
            cp android-kernel/out/arch/arm64/boot/Image AnyKernel3/
        else
            echo "❌ Error: Image not found!"
            exit 1
        fi
        
        # 去除机型验证，改为自动模式
        sed -i 's/do.devicecheck=1/do.devicecheck=0/g' AnyKernel3/anykernel.sh
        sed -i 's/IS_SLOT_DEVICE=0;/IS_SLOT_DEVICE=auto;/g' AnyKernel3/anykernel.sh
        
        # 打包
        cd AnyKernel3
        zip -r AK3-${{ inputs.KERNEL_BRANCH }}-rsuntk_KSU_${{ env.RSKSUVER }}.zip ./*

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Kernel-${{ inputs.KERNEL_BRANCH }}-rsuntk
        path: kernel_workspace/AnyKernel3/*.zip
