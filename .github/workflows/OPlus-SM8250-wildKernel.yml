name: Build Kernel (Fix Arch & Path)

on:
  workflow_dispatch:
    inputs:
      KSU_PROVIDER:
        description: 'é€‰æ‹© KernelSU æ ¸å¿ƒ'
        required: true
        default: 'FolkPatch'
        type: choice
        options:
          - 'FolkPatch'
          - 'WildKernels (Official)'
          - 'SukiSU-Ultra'
          - 'rsuntk'

      ENABLE_SUSFS:
        description: 'å¯ç”¨ SusFS'
        required: true
        type: boolean
        default: true

      SUSFS_VERSION:
        description: 'é€‰æ‹© SusFS ç‰ˆæœ¬'
        required: true
        default: 'v2.0'
        type: choice
        options:
          - 'v1.5.5'
          - 'v1.5.5-3b956a3'
          - 'v2.0'
          - 'v2.0-a083a21'

      USE_MANUAL_HOOK:
        description: 'å¯ç”¨ Manual Hook (æ¨èå¼€å¯)'
        required: true
        type: boolean
        default: true

      KERNEL_BRANCH:
        description: 'LineageOS åˆ†æ”¯'
        required: true
        default: 'lineage-23.1'
        
      CLANG_VERSION:
        description: 'Clang ç‰ˆæœ¬'
        required: true
        default: 'clang-r547379'
        
      KERNEL_DEFCONFIG:
        description: 'é…ç½®æ–‡ä»¶'
        required: true
        default: 'vendor/kona-perf_defconfig'

env:
  TZ: Asia/Shanghai
  GCC_TAG: android-12.1.0_r27
  KERNEL_SOURCE: 'https://github.com/LineageOS/android_kernel_oneplus_sm8250'

jobs:
  build:
    name: Build Kernel
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Set swap to 10G
      uses: pierotofy/set-swap-space@master
      with:
        swap-size-gb: 10

    - name: Setup Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y git ccache automake flex lzop bison gperf build-essential zip curl zlib1g-dev g++-multilib bzip2 libbz2-dev liblz4-tool make squashfs-tools dpkg-dev libssl-dev python3 bc libc6-dev-i386 libncurses5-dev
        mkdir -p $GITHUB_WORKSPACE/kernel_workspace

    - name: Cache Clang
      id: cache-clang
      uses: actions/cache@v4
      with:
        path: ${{ github.workspace }}/kernel_workspace/clang-aosp
        key: ${{ inputs.CLANG_VERSION }}

    - name: Download Clang
      if: steps.cache-clang.outputs.cache-hit != 'true'
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        mkdir -p clang-aosp
        wget -O clang.tar.gz https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/${{ inputs.CLANG_VERSION }}.tar.gz
        tar -C clang-aosp -zxvf clang.tar.gz

    - name: Cache GCC
      id: cache-gcc
      uses: actions/cache@v4
      with:
        path: ${{ github.workspace }}/kernel_workspace/gcc-64
        key: gcc-aarch64-${{ env.GCC_TAG }}

    - name: Download GCC
      if: steps.cache-gcc.outputs.cache-hit != 'true'
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        mkdir -p gcc-64
        wget -O gcc.tar.gz https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/+archive/refs/tags/${{ env.GCC_TAG }}.tar.gz
        tar -C gcc-64 -zxvf gcc.tar.gz

    - name: Clone Kernel Source
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        echo "â¬‡ï¸ Cloning LineageOS Source..."
        echo "ğŸŒ¿ Branch: ${{ inputs.KERNEL_BRANCH }}"
        git clone --recursive ${{ env.KERNEL_SOURCE }} -b ${{ inputs.KERNEL_BRANCH }} android-kernel --depth=1

    - name: Inject KernelSU (${{ inputs.KSU_PROVIDER }})
      run: |
        cd kernel_workspace/android-kernel
        
        echo "Injecting ${{ inputs.KSU_PROVIDER }}..."
        
        if [ "${{ inputs.KSU_PROVIDER }}" == "FolkPatch" ]; then
            curl -LSs "https://raw.githubusercontent.com/matsuzaka-yuki/FolkPatch/main/kernel/setup.sh" | bash -s main
        elif [ "${{ inputs.KSU_PROVIDER }}" == "SukiSU-Ultra" ]; then
            curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s main
        elif [ "${{ inputs.KSU_PROVIDER }}" == "WildKernels (Official)" ]; then
            curl -LSs "https://raw.githubusercontent.com/WildKernels/Wild_KSU/main/kernel/setup.sh" | bash -s main
        elif [ "${{ inputs.KSU_PROVIDER }}" == "rsuntk" ]; then
            curl -LSs "https://raw.githubusercontent.com/rsuntk/KernelSU/main/kernel/setup.sh" | bash -s main
        fi
        
        if [ -d "KernelSU" ]; then
            echo "KSU_DIR=KernelSU" >> $GITHUB_ENV
        else
            echo "âš ï¸ KSU directory not found!"
        fi

    - name: Inject SusFS (${{ inputs.SUSFS_VERSION }})
      if: inputs.ENABLE_SUSFS == true
      run: |
        cd kernel_workspace
        git clone https://gitlab.com/simonpunk/susfs4ksu.git -b ${{ inputs.SUSFS_VERSION }}
        
        cd android-kernel
        cp -af ../susfs4ksu/ksu/* ${{ env.KSU_DIR }}/
        cp -af ../susfs4ksu/include/linux/* include/linux/
        
        echo "SUSFS_VER=${{ inputs.SUSFS_VERSION }}" >> $GITHUB_ENV

    # âœ… ä¿®å¤é‡ç‚¹ï¼šåŠ ä¸Šäº† ARCH å’Œ PATH ç¯å¢ƒå˜é‡
    - name: ğŸ”¥ Apply Settings (Hook, LZ4, BBR)
      run: |
        cd kernel_workspace/android-kernel
        
        # ğŸŸ¢ ä¿®å¤1ï¼šå‘Šè¯‰ make æˆ‘ä»¬æ˜¯ç»™ ARM64 ç¼–è¯‘çš„
        export ARCH=arm64
        export SUBARCH=arm64
        
        # ğŸŸ¢ ä¿®å¤2ï¼šå‘Šè¯‰ make ç¼–è¯‘å™¨åœ¨å“ªé‡Œ (è§£å†³ ld.lld not found)
        export PATH=$GITHUB_WORKSPACE/kernel_workspace/clang-aosp/bin:$GITHUB_WORKSPACE/kernel_workspace/gcc-64/bin:$PATH
        
        CONFIG_PATH="arch/arm64/configs/${{ inputs.KERNEL_DEFCONFIG }}"
        
        if [ "${{ inputs.USE_MANUAL_HOOK }}" == "true" ]; then
            ./scripts/config --file $CONFIG_PATH --enable CONFIG_KSU_MANUAL_HOOK
        else
            ./scripts/config --file $CONFIG_PATH --disable CONFIG_KSU_MANUAL_HOOK
        fi
        
        if [ "${{ inputs.ENABLE_SUSFS }}" == "true" ]; then
            ./scripts/config --file $CONFIG_PATH --enable CONFIG_KSU_SUSFS
            ./scripts/config --file $CONFIG_PATH --enable CONFIG_KSU_SUSFS_SUS_PATH
            ./scripts/config --file $CONFIG_PATH --enable CONFIG_KSU_SUSFS_SUS_MOUNT
            ./scripts/config --file $CONFIG_PATH --enable CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT
            ./scripts/config --file $CONFIG_PATH --enable CONFIG_KSU_SUSFS_SUS_KSTAT
            ./scripts/config --file $CONFIG_PATH --enable CONFIG_KSU_SUSFS_SUS_OVERLAYFS
            ./scripts/config --file $CONFIG_PATH --enable CONFIG_KSU_SUSFS_TRY_UMOUNT
        fi

        ./scripts/config --file $CONFIG_PATH --enable CONFIG_KERNEL_LZ4
        ./scripts/config --file $CONFIG_PATH --disable CONFIG_KERNEL_GZIP
        ./scripts/config --file $CONFIG_PATH --enable CONFIG_TCP_CONG_BBR
        ./scripts/config --file $CONFIG_PATH --enable CONFIG_DEFAULT_BBR
        ./scripts/config --file $CONFIG_PATH --enable CONFIG_NETFILTER_XT_TARGET_TTL
        ./scripts/config --file $CONFIG_PATH --enable CONFIG_NETFILTER_XT_TARGET_HL
        
        # åˆ·æ–°é…ç½®
        make O=out CC=clang \
             CLANG_TRIPLE=aarch64-linux-gnu- \
             CROSS_COMPILE=aarch64-linux-android- \
             LD=ld.lld LL
