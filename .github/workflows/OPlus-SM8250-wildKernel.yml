name: Build Kernel (SusFS Custom)

on:
  workflow_dispatch:
    inputs:
      # 1. KernelSU æ ¸å¿ƒé€‰æ‹©
      KSU_PROVIDER:
        description: 'é€‰æ‹© KernelSU æ ¸å¿ƒ'
        required: true
        default: 'KernelSU-Next'
        type: choice
        options:
          - 'KernelSU-Next'
          - 'WildKernels (Official)'
          - 'SukiSU-Ultra'
          - 'rsuntk'

      # 2. SusFS æ¨¡å—æŽ§åˆ¶
      ENABLE_SUSFS:
        description: 'å¯ç”¨ SusFS (å¼€å¯åŽä¸‹æ–¹ç‰ˆæœ¬æ‰ç”Ÿæ•ˆ)'
        required: true
        type: boolean
        default: true

      SUSFS_VERSION:
        description: 'é€‰æ‹© SusFS ç‰ˆæœ¬'
        required: true
        default: 'v1.5.5'
        type: choice
        options:
          - 'v1.5.5'
          - 'v1.5.5-3b956a3'
          - 'v2.0'
          - 'v2.0-a083a21'

      # 3. æŒ‚é’©æ¨¡å¼æŽ§åˆ¶
      USE_MANUAL_HOOK:
        description: 'å¯ç”¨ Manual Hook (æŽ¨è 4.19 å†…æ ¸å¼€å¯)'
        required: true
        type: boolean
        default: true

      # 4. åŸºç¡€é…ç½®
      KERNEL_BRANCH:
        description: 'LineageOS åˆ†æ”¯'
        required: true
        default: 'lineage-23.1'
        
      CLANG_VERSION:
        description: 'Clang ç‰ˆæœ¬'
        required: true
        default: 'clang-r547379'
        
      KERNEL_DEFCONFIG:
        description: 'é…ç½®æ–‡ä»¶'
        required: true
        default: 'vendor/kona-perf_defconfig'

env:
  TZ: Asia/Shanghai
  GCC_TAG: android-12.1.0_r27
  KERNEL_SOURCE: 'https://github.com/LineageOS/android_kernel_oneplus_sm8250'

jobs:
  build:
    name: Build Kernel
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Set swap to 10G
      uses: pierotofy/set-swap-space@master
      with:
        swap-size-gb: 10

    - name: Setup Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y git ccache automake flex lzop bison gperf build-essential zip curl zlib1g-dev g++-multilib bzip2 libbz2-dev liblz4-tool make squashfs-tools dpkg-dev libssl-dev python3 bc libc6-dev-i386 libncurses5-dev
        mkdir -p $GITHUB_WORKSPACE/kernel_workspace

    - name: Cache Clang
      id: cache-clang
      uses: actions/cache@v4
      with:
        path: ${{ github.workspace }}/kernel_workspace/clang-aosp
        key: ${{ inputs.CLANG_VERSION }}

    - name: Download Clang
      if: steps.cache-clang.outputs.cache-hit != 'true'
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        mkdir -p clang-aosp
        wget -O clang.tar.gz https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/${{ inputs.CLANG_VERSION }}.tar.gz
        tar -C clang-aosp -zxvf clang.tar.gz

    - name: Cache GCC
      id: cache-gcc
      uses: actions/cache@v4
      with:
        path: ${{ github.workspace }}/kernel_workspace/gcc-64
        key: gcc-aarch64-${{ env.GCC_TAG }}

    - name: Download GCC
      if: steps.cache-gcc.outputs.cache-hit != 'true'
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        mkdir -p gcc-64
        wget -O gcc.tar.gz https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/+archive/refs/tags/${{ env.GCC_TAG }}.tar.gz
        tar -C gcc-64 -zxvf gcc.tar.gz

    - name: Clone Kernel Source
      run: |
        cd $GITHUB_WORKSPACE/kernel_workspace
        echo "â¬‡ï¸ Cloning LineageOS Source..."
        echo "ðŸŒ¿ Branch: ${{ inputs.KERNEL_BRANCH }}"
        git clone --recursive ${{ env.KERNEL_SOURCE }} -b ${{ inputs.KERNEL_BRANCH }} android-kernel --depth=1

    # 1. æ³¨å…¥ KernelSU
    - name: Inject KernelSU (${{ inputs.KSU_PROVIDER }})
      run: |
        cd kernel_workspace/android-kernel
        
        # ä¸ºäº†å…¼å®¹ SusFSï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ KSU ç›®å½•ç¡®åˆ‡å«ä»€ä¹ˆ
        # é€šå¸¸ setup.sh ä¼šè‡ªåŠ¨å¤„ç†ï¼Œä½†æˆ‘ä»¬è¦æ ‡è®°ä¸€ä¸‹
        
        if [ "${{ inputs.KSU_PROVIDER }}" == "WildKernels (Official)" ]; then
            curl -LSs "https://raw.githubusercontent.com/WildKernels/Wild_KSU/main/kernel/setup.sh" | bash -s main
        elif [ "${{ inputs.KSU_PROVIDER }}" == "KernelSU-Next" ]; then
            curl -LSs "https://raw.githubusercontent.com/rifsxd/KernelSU-Next/next/kernel/setup.sh" | bash -s next
        elif [ "${{ inputs.KSU_PROVIDER }}" == "SukiSU-Ultra" ]; then
            curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s main
        elif [ "${{ inputs.KSU_PROVIDER }}" == "rsuntk" ]; then
            curl -LSs "https://raw.githubusercontent.com/rsuntk/KernelSU/main/kernel/setup.sh" | bash -s main
        fi
        
        # å¯»æ‰¾ KSU ç›®å½•å
        if [ -d "KernelSU-Next" ]; then
            echo "KSU_DIR=KernelSU-Next" >> $GITHUB_ENV
        elif [ -d "KernelSU" ]; then
            echo "KSU_DIR=KernelSU" >> $GITHUB_ENV
        else
            echo "âš ï¸ KSU directory not found!"
        fi

    # 2. æ³¨å…¥ SusFS (é‡ç‚¹åŠŸèƒ½)
    - name: Inject SusFS (${{ inputs.SUSFS_VERSION }})
      if: inputs.ENABLE_SUSFS == true
      run: |
        cd kernel_workspace
        
        echo "â¬‡ï¸ Cloning SusFS ${{ inputs.SUSFS_VERSION }}..."
        git clone https://gitlab.com/simonpunk/susfs4ksu.git -b ${{ inputs.SUSFS_VERSION }}
        
        # å¼€å§‹åº”ç”¨ SusFS è¡¥ä¸
        # 1. æŠŠ SusFS çš„ä»£ç å¤åˆ¶åˆ° KernelSU ç›®å½•é‡Œ (ä¿®æ”¹ KSU æºç )
        # æ³¨æ„ï¼šè¿™é‡Œä¼šè¦†ç›– KSU åŽŸæœ‰çš„ä¸€äº›æ–‡ä»¶ï¼Œè¿™æ˜¯æ­£å¸¸çš„
        cd android-kernel
        cp -af ../susfs4ksu/ksu/* ${{ env.KSU_DIR }}/
        
        # 2. æŠŠ SusFS çš„å¤´æ–‡ä»¶å¤åˆ¶åˆ°å†…æ ¸ include ç›®å½•
        cp -af ../susfs4ksu/include/linux/* include/linux/
        
        # 3. å¼€å¯ SusFS è¡¥ä¸é€»è¾‘ (æ‰‹åŠ¨åº”ç”¨è¡¥ä¸)
        # 4.19 å†…æ ¸é€šå¸¸éœ€è¦ fs/ è¡¥ä¸ã€‚è¿™é‡Œå°è¯•è‡ªåŠ¨å¯»æ‰¾å¹¶åº”ç”¨
        # å¦‚æžœè‡ªåŠ¨è¡¥ä¸å¤±è´¥ï¼Œä¸è¦è®©æ•´ä¸ªç¼–è¯‘æŒ‚æŽ‰ï¼Œå°è¯•ç»§ç»­
        if [ -f "../susfs4ksu/kernel_patches/50_add_susfs_in_gki-android12-5.10.patch" ]; then
             # æ³¨æ„ï¼š4.19 å’Œ 5.10 ç»“æž„ä¸åŒï¼Œè¿™é‡Œä¸»è¦ä¾èµ– KSU å†…éƒ¨çš„ä¿®æ”¹
             # SusFS åœ¨éž GKI å†…æ ¸ä¸Šä¸»è¦ä¾èµ– KSU å†…éƒ¨æŒ‚é’©ï¼Œfs patch å¯èƒ½ä¸å…¼å®¹
             echo "âš ï¸ SusFS on 4.19 relies mostly on KSU modification."
        fi
        
        echo "âœ… SusFS injected into ${{ env.KSU_DIR }}"
        
        # è®°å½•ç‰ˆæœ¬
        echo "SUSFS_VER=${{ inputs.SUSFS_VERSION }}" >> $GITHUB_ENV

    # 3. åŸºç¡€ä¼˜åŒ– + å¼€å…³æŽ§åˆ¶
    - name: ðŸ”¥ Apply Settings (Hook, LZ4, BBR)
      run: |
        cd kernel_workspace/android-kernel
        CONFIG_PATH="arch/arm64/configs/${{ inputs.KERNEL_DEFCONFIG }}"
        
        # === æ ¸å¿ƒå¼€å…³ï¼šManual Hook ===
        if [ "${{ inputs.USE_MANUAL_HOOK }}" == "true" ]; then
            echo "âœ… Enabling Manual Hook..."
            ./scripts/config --file $CONFIG_PATH --enable CONFIG_KSU_MANUAL_HOOK
        else
            echo "ðŸš« Disabling Manual Hook..."
            ./scripts/config --file $CONFIG_PATH --disable CONFIG_KSU_MANUAL_HOOK
        fi
        
        # === æ ¸å¿ƒå¼€å…³ï¼šSusFS ===
        if [ "${{ inputs.ENABLE_SUSFS }}" == "true" ]; then
            echo "âœ… Enabling SusFS Config..."
            ./scripts/config --file $CONFIG_PATH --enable CONFIG_KSU_SUSFS
            ./scripts/config --file $CONFIG_PATH --enable CONFIG_KSU_SUSFS_SUS_PATH
            # å¼€å¯éšè—ç›¸å…³æ”¯æŒ
            ./scripts/config --file $CONFIG_PATH --enable CONFIG_KSU_SUSFS_SUS_MOUNT
            ./scripts/config --file $CONFIG_PATH --enable CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT
            ./scripts/config --file $CONFIG_PATH --enable CONFIG_KSU_SUSFS_SUS_KSTAT
            ./scripts/config --file $CONFIG_PATH --enable CONFIG_KSU_SUSFS_SUS_OVERLAYFS
            ./scripts/config --file $CONFIG_PATH --enable CONFIG_KSU_SUSFS_TRY_UMOUNT
        fi

        # === åŸºç¡€ä¼˜åŒ– (LZ4, BBR, TTL) ===
        ./scripts/config --file $CONFIG_PATH --enable CONFIG_KERNEL_LZ4
        ./scripts/config --file $CONFIG_PATH --disable CONFIG_KERNEL_GZIP
        ./scripts/config --file $CONFIG_PATH --enable CONFIG_TCP_CONG_BBR
        ./scripts/config --file $CONFIG_PATH --enable CONFIG_DEFAULT_BBR
        ./scripts/config --file $CONFIG_PATH --enable CONFIG_NETFILTER_XT_TARGET_TTL
        ./scripts/config --file $CONFIG_PATH --enable CONFIG_NETFILTER_XT_TARGET_HL
        
        # åˆ·æ–°é…ç½®
        make O=out CC=clang \
             CLANG_TRIPLE=aarch64-linux-gnu- \
             CROSS_COMPILE=aarch64-linux-android- \
             LD=ld.lld LLVM=1 LLVM_IAS=1 \
             ${{ inputs.KERNEL_DEFCONFIG }}
             
        # èŽ·å– KSU ç‰ˆæœ¬
        cd ${{ env.KSU_DIR }}
        KSUVER=$(expr $(git rev-list --count HEAD) + 10000)
        echo "KSUVER=$KSUVER" >> $GITHUB_ENV
        cd ..
        
        sed -i 's/ -dirty//g' scripts/setlocalversion

    - name: Build Kernel
      run: |
        cd kernel_workspace/android-kernel
        export ARCH=arm64
        export SUBARCH=arm64
        export BRAND_SHOW_FLAG=oneplus
        export PATH=$GITHUB_WORKSPACE/kernel_workspace/clang-aosp/bin:$GITHUB_WORKSPACE/kernel_workspace/gcc-64/bin:$PATH
        
        make -j$(nproc --all) O=out CC=clang \
             CLANG_TRIPLE=aarch64-linux-gnu- \
             CROSS_COMPILE=aarch64-linux-android- \
             LD=ld.lld LLVM=1 LLVM_IAS=1

    - name: Package AnyKernel3
      run: |
        cd kernel_workspace
        git clone --depth=1 https://github.com/osm0sis/AnyKernel3
        
        if [ -f android-kernel/out/arch/arm64/boot/Image.lz4 ]; then
            cp android-kernel/out/arch/arm64/boot/Image.lz4 AnyKernel3/Image
        elif [ -f android-kernel/out/arch/arm64/boot/Image ]; then
            cp android-kernel/out/arch/arm64/boot/Image AnyKernel3/
        else
            echo "âŒ Error: Image not found!"
            exit 1
        fi
        
        sed -i 's/do.devicecheck=1/do.devicecheck=0/g' AnyKernel3/anykernel.sh
        sed -i 's/IS_SLOT_DEVICE=0;/IS_SLOT_DEVICE=auto;/g' AnyKernel3/anykernel.sh
        
        cd AnyKernel3
        # åŒ…åæ˜¾ç¤º SusFS ç‰ˆæœ¬
        SUS_TAG=""
        if [ "${{ inputs.ENABLE_SUSFS }}" == "true" ]; then
            SUS_TAG="-SusFS-${{ inputs.SUSFS_VERSION }}"
        fi
        
        zip -r AK3-${{ inputs.KERNEL_BRANCH }}-${{ inputs.KSU_PROVIDER }}${SUS_TAG}_${{ env.KSUVER }}.zip ./*
        echo "ZIP_PATH=$(ls *.zip)" >> $GITHUB_ENV

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Kernel-${{ inputs.KERNEL_BRANCH }}-${{ inputs.KSU_PROVIDER }}
        path: kernel_workspace/AnyKernel3/*.zip

    - name: ðŸ“± Send to Telegram
      if: success()
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        cd kernel_workspace/AnyKernel3
        
        CAPTION="ðŸ›  *Custom Kernel Build!*%0A%0A"
        CAPTION+="ðŸ”¸ *KSU:* \`${{ inputs.KSU_PROVIDER }}\`%0A"
        CAPTION+="ðŸ”¸ *SusFS:* \`${{ inputs.SUSFS_VERSION }}\` (Enabled: ${{ inputs.ENABLE_SUSFS }})%0A"
        CAPTION+="ðŸ”¸ *Manual Hook:* \`${{ inputs.USE_MANUAL_HOOK }}\`%0A"
        CAPTION+="ðŸ”¸ *Optimization:* \`LZ4 + BBR\`%0A"
        
        curl -s -F chat_id=$TELEGRAM_CHAT_ID \
             -F document=@${{ env.ZIP_PATH }} \
             -F parse_mode=Markdown \
             -F caption="$CAPTION" \
             https://api.telegram.org/bot$TELEGRAM_TOKEN/sendDocument
